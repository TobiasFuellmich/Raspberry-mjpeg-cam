import RPi.GPIO as GPIO
import time
from os import stat

GPIO.setmode(GPIO.BCM)
GPIO.setup(18, GPIO.OUT)
GPIO.setup(19, GPIO.OUT)
GPIO.setup(20, GPIO.OUT)
GPIO.setup(22, GPIO.OUT)
GPIO.setup(23, GPIO.OUT)
GPIO.setup(24, GPIO.OUT)
GPIO.setup(25, GPIO.OUT)
GPIO.setup(26, GPIO.OUT)

def stepps(s,in1,in2,in3,in4):
	if s==1:
		GPIO.output(in1, 0)
		GPIO.output(in2, 0)
		GPIO.output(in3, 0)
		GPIO.output(in4, 1)
	elif s==2:
		GPIO.output(in1, 0)
		GPIO.output(in2, 0)
		GPIO.output(in3, 1)
		GPIO.output(in4, 1)
	elif s==3:
		GPIO.output(in1, 0)
		GPIO.output(in2, 0)
		GPIO.output(in3, 1)
		GPIO.output(in4, 0)
	elif s==4:
		GPIO.output(in1, 0)
		GPIO.output(in2, 1)
		GPIO.output(in3, 1)
		GPIO.output(in4, 0)
	elif s==5:
		GPIO.output(in1, 0)
		GPIO.output(in2, 1)
		GPIO.output(in3, 0)
		GPIO.output(in4, 0)
	elif s==6:
		GPIO.output(in1, 1)
		GPIO.output(in2, 1)
		GPIO.output(in3, 0)
		GPIO.output(in4, 0)
	elif s==7:
		GPIO.output(in1, 1)
		GPIO.output(in2, 0)
		GPIO.output(in3, 0)
		GPIO.output(in4, 0)
	elif s==8:
		GPIO.output(in1, 1)
		GPIO.output(in2, 0)
		GPIO.output(in3, 0)
		GPIO.output(in4, 1)
	
i=0
timeout=0
dir="stop"
file = open("/var/www/html/stepper/step_keep.lock", "w")
file.write("stop")
file.close()
path ='/var/www/html/stepper/step_keep.lock'
st_time=stat(path).st_mtime
while True:
	if dir!="stop":
		if dir=="forward":
			stepps(i%8+1,22,20,19,18)
			stepps(i%8+1,23,24,25,26)
		elif dir=="left":
			stepps(((i%8-8)*-1)-1,23,24,25,26)
			stepps(i%8+1,22,20,19,18)
		elif dir=="right":
			stepps(i%8+1,23,24,25,26)
			stepps(((i%8-8)*-1)-1,22,20,19,18)
		elif dir=="backward":
			stepps(((i%8-8)*-1)-1,23,24,25,26)
			stepps(((i%8-8)*-1)-1,22,20,19,18)
	
	time.sleep(0.001)
	i=i+1
	if i>=127:
		i=0
		file = open("/var/www/html/stepper/step_keep.lock", "r")
		n_dir=str(file.read())
		file.close()
		if n_dir!=dir:
			dir=n_dir
			timeout=0
		else:
			n_st_time=stat(path).st_mtime
			if st_time!=n_st_time:
				st_time=n_st_time
				timeout=0
			else:
				timeout=timeout+1
				if timeout>=28:
					dir="stop"



